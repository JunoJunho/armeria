# Building a client using ClientFactoryBuilder

A <type://ClientFactoryBuilder> is a builder class that enables you to create a client factory
which is able to customize various parameters. For example, some people want to make longer connection timeout.
If so, the builder provides connectTimeoutMillis to change from the default value to what you want to change.

You can simply create <type://ClientFactoryBuilder> as following example:

```java
try (ClientFactory factory =
          ClientFactory.builder()
                       // Set the connection timeout to 5 seconds.
                       .connectTimeoutMillis(5000)
                       // Disable certificate verification; never do this in production!
                       .tlsNoVerify()
                       .build()) {
   final WebClient client = WebClient.builder()
                                     .factory(factory)
                                     .build();
   // do something with web client
  }
```

As above example, <type://WebClientBuilder> or <type://ClientBuilder> are able to use <type://ClientFactory>
which is created from <type://ClientFactoryBuilder> using method `factory`. The <type://ClientBuilder> instance
will use all parameters from the instance <type://ClientFactoryBuilder> that you defined.

## What are available parameters?

The parameters that are available in <type://ClientFactoryBuilder> keep changing and growing the total numbers.
It would be better for you to check latest version of API docs [here](https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientFactoryBuilder.html).

## Set parameters using Client Options

The <type://ClientFactoryBuilder> class provides a manner to define parameters using <type://ClientOption>.
The <type://ClientOptions> class already has above parameters with proper types. Using <type://ClientOption>,
you can define your own properties either.

```java
final EventLoopGroup customExcutorGroup = EventLoopGroups.newEventLoopGroup(2);
// define custom ClientFactoryOption
final ClientFactoryOption<Boolean> fooOption = ClientFactoryOption.define("FOO", true);
try (ClientFactory factory =
             ClientFactory.builder()
                          // define a new event loop worker group to execute logic from the builder
                          .option(ClientFactoryOptions.WORKER_GROUP, customExcutorGroup)
                          // set the custom factory option in builder
                          .option(fooOption, false)
                          .build()) {
    // options method will return options including fooOption
    factory.options();
    // do something with factory
}
```

## Netty specific Channel Options

You can also edit Netty <type://ChannelOption> using `ClientFactoryBuilder.channelOption` method. For example,
if you want to change the size of send socket buffer, you can edit the value as following:

```java
try (ClientFactory factory =
             ClientFactory.builder()
                          // Set the size of send socket buffer as 4096 bytes
                          .channelOption(ChannelOption.SO_SNDBUF, 4096)
                          .build()) {
    // do something with factory
}
```

## Setting different EventLoops for different endpoints

To increase performance or capacity of a client, it could be possible that increasing the number of connections.
The <type://ClientFactoryBuilder> class has a feature to set the number of `EventLoop` threads using
`maxNumEventLoopsPerEndpoint` and `maxNumEventLoopsFunction`. The former parameter will set the number of `EventLoop`
threads for each end point (This parameter is used for HTTP/2. If you want to articulate this feature in HTTP/1,
use `maxNumEventLoopsPerHttp1Endpoint` instead.). It indicates that if you change this value `N`,
then Client instances that are generated by the factory will use distinct `EventLoop` threads per endpoint.

```java
try (ClientFactory factory =
        ClientFactory.builder()
                     // a client will use maximum 5 connections to communicate with each endpoint
                     .maxNumEventLoopsPerEndpoint(5)
                     .build()) {
    // Do something using factory
}
```

However, `maxNumEventLoopsFunction` will enable you to set more flexible ways to set `EventLoop` threads for
endpoints. You can set this parameter as follows:

```java
try (ClientFactory factory =
        ClientFactory.builder()
                     .maxNumEventLoopsFunction(endpoint -> {
                         if (endpoint.equals(Endpoint.of("foo.com"))) {
                             // 5 connections will manage foo.com endpoint
                             return 5;
                         }
                         if (endpoint.host().contains("bar.com")) {
                             // The value will be clamped by the number of event loops
                             return Integer.MAX_VALUE;
                         }
                         return -1; // 0 or negative number is default value
                     })
                     .build()) {
    // Do something using factory
}
```

Note that if both parameters are used in one factory, except endpoints that specified in `maxNumEventLoopsFunction`,
`maxNumEventLoopsPerEndpoint` will be used. If you do not set this value, default value, which is 1 is used.

## Customize TLS

There might be possible that you need to use third-party CA to configure SSL connections.
To deal with it, <type://ClientFactoryBuilder> supports `tlsCustomizer` parameter. You need to add `Consumer`
to cover customized ssl connections.

```java
final String resourceRoot = "/path/to/resourceRoot";
final String privateKeyPath = "private/keyPath";
try (ClientFactory builder =
         ClientFactory.builder()
                      .tlsCustomizer(
                          sslCtxBuilder -> sslCtxBuilder.keyManager(
                                  getClass().getResourceAsStream(resourceRoot + "custom.crt"),
                                  getClass().getResourceAsStream(resourceRoot + privateKeyPath))
                      ).build()) {
    // do something
}
```

