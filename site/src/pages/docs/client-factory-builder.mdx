# Customizing a `ClientFactory` with `ClientFactoryBuilder`

A <type://ClientFactoryBuilder> is a builder class that enables you to create a <type://ClientFactory>
with custom options. For example, you might need to use the `connectTimeoutMillis` method to adjust the
connection timeout of your clients.

```java
try (ClientFactory factory =
          ClientFactory.builder()
                       // Set the connection timeout to 5 seconds.
                       .connectTimeoutMillis(5000)
                       .build()) {
   final WebClient client = WebClient.builder()
                                     .factory(factory)
                                     .build();
   // do something with web client
  }
```

As shown in the above example, you can specify a custom <type://ClientFactory> when building a client
via the <type://ClientFactoryBuilder#factory()> method.
The client created with the given <type://ClientFactory> will respect the settings such as connection timeout
as you defined.

## What options are available?

See <type://ClientFactoryBuilder> for the complete list of customizable options.

## Setting options with `ClientOption`

You can customize a <type://ClientFactoryBuilder> using a <type://ClientFactoryOption> as well.
It's more verbose than calling a dedicated setter method, but it can be useful when you need to
set a series of options programmatically:

```java
final EventLoopGroup customExcutorGroup = EventLoopGroups.newEventLoopGroup(2);
try (ClientFactory factory =
             ClientFactory.builder()
                          // define a new event loop worker group to execute logic from the builder
                          .option(ClientFactoryOptions.WORKER_GROUP, customExcutorGroup)
                          .build()) {
    // options method will return options that used in your builder
    factory.options();
    // do something with factory
}
```

## Specifying Netty `ChannelOption`s

You can also specify Netty [`ChannelOption`](https://netty.io/4.1/api/io/netty/channel/ChannelOption.html)
with <type://ClientFactoryBuilder#channelOption()> method:

```java
try (ClientFactory factory =
             ClientFactory.builder()
                          // Set the size of send socket buffer as 4096 bytes
                          .channelOption(ChannelOption.SO_SNDBUF, 4096)
                          .build()) {
    // do something with factory
}
```

## Specifying different `EventLoop` threads for different endpoints

By default, Armeria keeps at most 1 connection per endpoint (host and port pair) in case of using HTTP/2,
which is desirable for typical HTTP/2 services. Armeria achieves this by assigning one `EventLoop` per endpoint
from the <type://ServerConfig#workerGroup()>. However, there's a limit to the requests that
a single connection(or `EventLoop` which is a thread) can handle, so you might want to increase
the number of connections(or `EventLoop` threads) for certain or all endpoints.

You can do this via <type://ClientFactoryBuilder#maxNumEventLoopsPerEndpoint(int)>:

The <type://ClientFactoryBuilder> class has a feature to set the number of `EventLoop` threads using
`maxNumEventLoopsPerEndpoint` and `maxNumEventLoopsFunction`. The former parameter will set the number of `EventLoop`
threads for each endpoint (This parameter is used for HTTP/2. If you want to articulate this feature in HTTP/1,
use `maxNumEventLoopsPerHttp1Endpoint` instead.). It indicates that if you change this value `N`,
then Client instances that are generated by the factory will use distinct `EventLoop` threads per endpoint.

```java
try (ClientFactory factory =
        ClientFactory.builder()
                     // a client will use maximum 5 EventLoops from the worker group per endpoint
                     .maxNumEventLoopsPerEndpoint(5)
                     .build()) {
    // Do something using factory
}

try (ClientFactory factory =
        ClientFactory.builder()
                     // or you can just use Integer.MAX_VALUE to use all EventLoops
                     .maxNumEventLoopsPerEndpoint(Integer.MAX_VALUE)
                     .build()) {
    // Do something using factory
}
```

The client might need to send many requests to a certain endpoint, while not bothering other endpoints.
In that situation, you can use <type://ClientFactoryBuilder#maxNumEventLoopsPerEndpoint(ToIntFunction)>:

```java
try (ClientFactory factory =
        ClientFactory.builder()
                     .maxNumEventLoopsFunction(endpoint -> {
                         if (endpoint.equals(Endpoint.of("lotsOfTraffic.com"))) {
                         // We are going to use all EventLoops to send reqeusts.
                             return Integer.MAX_VALUE;
                         }
                         // We use just one `EventLoop` per endpoint for the rest.
                         return 1;
                     })
                     .build()) {
    // Do something using factory
}
```

If HTTP/1.1 is used, the client can establish many connections even though only one EventLoop is used.
It is because of the nature that a client can send only one request at a time using HTTP/1.1 connection.
You can increase the number of `EventLoop` threads per HTTP/1.1 endpoint to distribute the load
via <type://ClientFactoryBuilder#maxNumEventLoopsPerHttp1Endpoint(int)>.

## Customizing TLS

You can configure the TLS settings of your client connection
with <type://ClientFactory#tlsCustomizer()>. For example, you could specify a different
CA certificate chain, configure TLS or enforce certain cipher suites.

```java
final String resourceRoot = "/path/to/resourceRoot";
final String privateKeyPath = "private/keyPath";
try (ClientFactory builder =
         ClientFactory.builder()
                      .tlsCustomizer(
                          sslCtxBuilder -> sslCtxBuilder.keyManager(
                                  getClass().getResourceAsStream(resourceRoot + "custom.crt"),
                                  getClass().getResourceAsStream(resourceRoot + privateKeyPath))
                      ).build()) {
    // do something
}
```

