# Building a client using ClientFactoryBuilder

A <type://ClientFactoryBuilder> is a builder class that enables you to create a <type://ClientFactory>
with custom options. For example, you might need to use the `connectTimeoutMillis` method to adjust the
connection timeout of your clients.
If so, the <type://ClientFactoryBuilder> provides `connectTimeoutMillis` to change from the default value
to what you want to change.

```java
try (ClientFactory factory =
          ClientFactory.builder()
                       // Set the connection timeout to 5 seconds.
                       .connectTimeoutMillis(5000)
                       .build()) {
   final WebClient client = WebClient.builder()
                                     .factory(factory)
                                     .build();
   // do something with web client
  }
```

As shown in the above example, you can specify a custom <type://ClientFactory> when building a client
via the <type://ClientFactoryBuilder#factory()> method.
The client created with the given <type://ClientFactory> will respect the settings such as connection timeout
as you defined.

## What options are available?

[See](https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientFactoryBuilder.html)
API documentation <type://ClientFactoryBuilder> for the complete list of customizable options.

## Setting options with ClientOption

You can customize a <type://ClientFactoryBuilder> using a <type://ClientFactoryOption> as well.
It's more verbose than calling a dedicated setter method, but it can be useful when you need to
set a series of options programmatically:

```java
final EventLoopGroup customExcutorGroup = EventLoopGroups.newEventLoopGroup(2);
try (ClientFactory factory =
             ClientFactory.builder()
                          // define a new event loop worker group to execute logic from the builder
                          .option(ClientFactoryOptions.WORKER_GROUP, customExcutorGroup)
                          .build()) {
    // options method will return options that used in your builder
    factory.options();
    // do something with factory
}
```

## Specifying Netty ChannelOptions

You can also specify Netty [`ChannelOption`](https://netty.io/4.1/api/io/netty/channel/ChannelOption.html)
with <type://ClientFactoryBuilder#channelOption()> method:

```java
try (ClientFactory factory =
             ClientFactory.builder()
                          // Set the size of send socket buffer as 4096 bytes
                          .channelOption(ChannelOption.SO_SNDBUF, 4096)
                          .build()) {
    // do something with factory
}
```

## Specifying different EventLoops for different endpoints

By default, Armeria keeps at most 1 connection per endpoint (host and port pair), which is desirable
for typical HTTP/2 services. However, you might want to increase the number of connections for
certain or all endpoints.

The <type://ClientFactoryBuilder> class has a feature to set the number of `EventLoop` threads using
`maxNumEventLoopsPerEndpoint` and `maxNumEventLoopsFunction`. The former parameter will set the number of `EventLoop`
threads for each end point (This parameter is used for HTTP/2. If you want to articulate this feature in HTTP/1,
use `maxNumEventLoopsPerHttp1Endpoint` instead.). It indicates that if you change this value `N`,
then Client instances that are generated by the factory will use distinct `EventLoop` threads per endpoint.

```java
try (ClientFactory factory =
        ClientFactory.builder()
                     // a client will use maximum 5 connections to communicate with each endpoint
                     .maxNumEventLoopsPerEndpoint(5)
                     .build()) {
    // Do something using factory
}
```

However, `maxNumEventLoopsFunction` will enable you to set more flexible ways to set `EventLoop` threads for
endpoints. You can set this parameter as follows:

```java
try (ClientFactory factory =
        ClientFactory.builder()
                     .maxNumEventLoopsFunction(endpoint -> {
                         if (endpoint.equals(Endpoint.of("foo.com"))) {
                             // 5 connections will manage foo.com endpoint
                             return 5;
                         }
                         if (endpoint.host().contains("bar.com")) {
                             // The value will be clamped by the number of event loops
                             return Integer.MAX_VALUE;
                         }
                         return -1; // 0 or negative number is default value
                     })
                     .build()) {
    // Do something using factory
}
```

Note that if both parameters are used in one factory, except endpoints that specified in `maxNumEventLoopsFunction`,
`maxNumEventLoopsPerEndpoint` will be used. If you do not set this value, default value, which is 1 is used.

## Customizing TLS

You can configure the TLS settings of your client connection
with <type://ClientFactory#tlsCustomizer()>. For example, you could specify a different
CA certificate chain, configure mTLS or enforce certain cipher suites.

```java
final String resourceRoot = "/path/to/resourceRoot";
final String privateKeyPath = "private/keyPath";
try (ClientFactory builder =
         ClientFactory.builder()
                      .tlsCustomizer(
                          sslCtxBuilder -> sslCtxBuilder.keyManager(
                                  getClass().getResourceAsStream(resourceRoot + "custom.crt"),
                                  getClass().getResourceAsStream(resourceRoot + privateKeyPath))
                      ).build()) {
    // do something
}
```

